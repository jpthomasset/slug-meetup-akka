<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Akka't the feeling</title>
<meta name="author" content="(Jean-Pierre Thomasset)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/css/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/css/theme/solarized.css" id="theme"/>

<link rel="stylesheet" href="style.css"/>

<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">

<section>
<section id="slide-orgeceec81">
<h2 id="orgeceec81">Akka't the feeling</h2>
<p>
A humble feedback on Akka after some time in production
</p>

</section>
</section>
<section>
<section id="slide-orgd66599f">
<h2 id="orgd66599f">Who are we ?</h2>

<div class="figure">
<p><img src="./img/logo_avencall.png" alt="logo_avencall.png" />
</p>
</div>
<ul>
<li>Open source software editor</li>
<li>7 developers across two locations (Lyon / Prague)</li>
<li>Mostly junior in Scala</li>

</ul>

</section>
<section id="slide-orgdd86de0">
<h3 id="orgdd86de0">XiVO Solution</h3>

<div class="figure">
<p><img src="./img/logo_xivo.png" alt="logo_xivo.png" />
</p>
</div>

<ul>
<li>Open Source IPBX based on Asterisk™</li>
<li>Phone Device Management</li>
<li>Call routing</li>
<li>Call Center Solution</li>
<li>Computer telephony Integration</li>

</ul>

</section>
<section id="slide-orga5420f7">
<h3 id="orga5420f7">XiVO Architecture overview</h3>

<div class="figure">
<p><img src="./img/xivo-overview.png" alt="xivo-overview.png" />
</p>
</div>

</section>
<section id="slide-org4bdc08b">
<h3 id="org4bdc08b">XUC Server</h3>
<ul>
<li>Real time message processing application</li>
<li>Using Akka</li>
<li>Expose API through Websocket &amp; Rest.</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgc2bbe34">
<h2 id="orgc2bbe34">Akka</h2>
<blockquote nil>
<p>
“Akka is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala”
</p>

<p>
&#x2013; <a href="http://akka.io/">http://akka.io/</a>
</p>
</blockquote>

</section>
<section id="slide-org3fac3ed">
<h3 id="org3fac3ed">Akka Basics</h3>
<blockquote nil>
<p>
“Akka is <i>the</i> implementation of the Actor Model on the JVM.
</p>
<ul>
<li>Simpler Concurrent &amp; Distributed Systems</li>
<li>Resilient</li>
<li>High Performance</li>
<li>Elastic &amp; Decentralized”</li>

</ul>
</blockquote>

<blockquote  class="fragment appear">
<p>
“Multi-threading for dummies” <div align="right"><i>Jean-Yves Lebleu</i></div>
</p>
</blockquote>

</section>
<section id="slide-org2287e12">
<h3 id="org2287e12">Actors</h3>
<p>
Actors can:
</p>
<ul>
<li class="fragment appear">Receive messages</li>
<li class="fragment appear">Do things</li>
<li class="fragment appear">Send messages</li>

</ul>

<div class="org-src-container">

<pre  class="fragment appear"><span style="color: #F92672;">class</span> <span style="color: #66D9EF;">HelloActor</span> <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #E6DB74;">"Hello"</span> <span style="color: #F92672;">=&gt;</span>
      sender ! <span style="color: #E6DB74;">"Hi !"</span>
}
</pre>
</div>

</section>
<section id="slide-orga9f7778">
<h3 id="orga9f7778">A <del>call</del> tell B</h3>

<div class="figure">
<p><img src="./img/a_tell_b.png" alt="a_tell_b.png" />
</p>
</div>

<p>
Simple use cases are easy to implement but complexity kicks pretty soon.
</p>

</section>
<section id="slide-org813855a">
<h3 id="org813855a">A <del>call</del> tell B (continued)</h3>
<div class="org-src-container">

<pre  class="src src-scala"><span style="color: #F92672;">case</span> <span style="color: #F92672;">class</span> <span style="color: #66D9EF;">Hello</span>(name<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)
<span style="color: #F92672;">case</span> <span style="color: #F92672;">class</span> <span style="color: #66D9EF;">Greetings</span>(message<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">HelloActor</span>(greetingsRef<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>) {
  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">preStart</span><span style="color: #F92672;">:</span> <span style="color: #66D9EF;">Unit</span> <span style="color: #F92672;">=</span> {
    greetingsRef ! <span style="color: #AE81FF;">Hello</span>(<span style="color: #E6DB74;">"Jean-Pierre"</span>)
  }

  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">Greetings</span>(<span style="color: #FD971F;">message</span>) <span style="color: #F92672;">=&gt;</span>
      println(s<span style="color: #E6DB74;">"</span><span style="color: #FD971F;">$greetingsRef</span><span style="color: #E6DB74;"> told </span><span style="color: #FD971F;">$message</span><span style="color: #E6DB74;">"</span>)
  }
}

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">GreetingsActor</span> <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">Hello</span>(<span style="color: #FD971F;">name</span>) <span style="color: #F92672;">=&gt;</span>
      <span style="color: #75715E;">// </span><span style="color: #75715E;">I can do something here...</span>
      sender ! <span style="color: #AE81FF;">Greetings</span>(s<span style="color: #E6DB74;">"Hi </span><span style="color: #FD971F;">$name</span><span style="color: #E6DB74;">!"</span>)
}
</pre>
</div>

</section>
<section id="slide-org77ad82c">
<h3 id="org77ad82c">Actors message processing</h3>
<p>
Akka guarantees for Actors:
</p>
<ul>
<li>Only one message processed at a time</li>
<li>No concurrency inside an actor</li>
<li>At-most-once delivery</li>
<li>Message ordering per <b>sender-receiver pair</b></li>

</ul>


</section>
</section>
<section>
<section id="slide-orga8971d7">
<h2 id="orga8971d7">Akka @ Avencall</h2>
<blockquote nil>
<p>
Akka is a toolkit for building highly concurrent, <del>distributed</del>, and resilient message-driven applications for <del>Java and</del> Scala
</p>

<p>
&#x2013; <a href="http://akka.io/">http://akka.io/</a>
</p>
</blockquote>

</section>
<section id="slide-orgf8df32c">
<h3 id="orgf8df32c">Actor Hierarchy</h3>
<p>
One of our major problem was designing the Actor Hierarchy.
</p>


<div class="figure">
<p><img src="./img/no_hierarchy.png" alt="no_hierarchy.png" />
</p>
</div>

<p>
Or the lack of designing process&#x2026;
</p>

</section>
<section id="slide-org0debad5">
<h3 id="org0debad5">Actor Hierarchy</h3>
<p>
Is <i>the</i> key to have a resilient and understandable system&#x2026;
</p>

<ul>
<li>Actors dependency / discovery</li>
<li>Startup / Shutdown</li>
<li>Recovery</li>
<li>Message path</li>

</ul>

</section>
<section id="slide-orgcafc263">
<h3 id="orgcafc263">Actor Hierarchy - Designing</h3>

<div class="figure">
<p><img src="./img/hierarchy.png" alt="hierarchy.png" />
</p>
</div>

<p>
Designing will help you:
</p>
<ul>
<li>Split concerns and avoid bloated actors</li>
<li>Define clear message path</li>
<li>Evaluate behaviour without implementation</li>

</ul>

<p class="fragment appear">
Bonus: The actor model is easily mapped from a real world model.
</p>

</section>
<section id="slide-orgbfb004c">
<h3 id="orgbfb004c">Supervision &amp; Recovery</h3>
<p>
Without any strategy, actors can die and respawn without notice&#x2026;
</p>

<p class="fragment appear">
For each actor, you need to define a clear strategy for:
</p>
<ul>
<li class="fragment appear">Startup</li>
<li class="fragment appear">Shutdown</li>
<li class="fragment appear">Recovery</li>
<li class="fragment appear">Failure of its children</li>

</ul>

<p class="fragment appear">
Again, designing a hierarchy of actors will help in this process.
</p>

</section>
<section id="slide-org6b07c93">
<h3 id="org6b07c93">Message</h3>
<ul>
<li class="fragment appear">Messages need to be immutable: 
<ul>
<li>To prevent side effects</li>
<li>To avoid access exception</li>

</ul></li>
<li class="fragment appear">And serializable if system is distributed</li>

</ul>

<p class="fragment appear">
Bonus: Scala offers <code>case class</code>, use them
</p>

</section>
<section id="slide-org1137cd3">
<h3 id="org1137cd3">Message Path &amp; Routing</h3>
<p>
Messages can be hard to track (to put it mildly)
</p>
<ul>
<li class="fragment appear">Define them close to where they're used.</li>
<li class="fragment appear">Avoid complex routing or message over encapsulation</li>
<li class="fragment appear">Prefer event sourcing over query pattern</li>
<li class="fragment appear">Design, design, design&#x2026;</li>

</ul>

</section>
<section id="slide-orgc0ad9b5">
<h3 id="orgc0ad9b5">Actor consistency</h3>
<p>
Do not try to be accurate, best effort is almost always enough.
Consistency
Un message c'est déjà le passé
</p>

</section>
<section id="slide-orgccb8b08">
<h3 id="orgccb8b08">Actor Reference 1/4</h3>
<p>
In a non-trivial architecture, you will need your actors to collaborate.
</p>

<p>
They will need to know each other (somehow).
</p>

</section>
<section id="slide-orga6e8f06">
<h3 id="orga6e8f06">Actor Reference 2/4</h3>
<p>
Possible strategies:
</p>
<ul>
<li class="fragment appear">Inject ActorRef in Actor constructor</li>
<li class="fragment appear">Let the Actors introduce themselves</li>

</ul>

<div class="org-src-container">

<pre  class="fragment appear"><span style="color: #F92672;">case</span> <span style="color: #F92672;">class</span> <span style="color: #66D9EF;">IntroduceMe</span>(someFriend<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>, message<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">FriendlyActor</span>(friend<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>) <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">preStart</span><span style="color: #F92672;">:</span> <span style="color: #66D9EF;">Unit</span> <span style="color: #F92672;">=</span> {
    friend ! <span style="color: #AE81FF;">IntroduceMe</span>(self, <span style="color: #E6DB74;">"Hi there !"</span>)
  }
  <span style="color: #75715E;">// </span><span style="color: #75715E;">...</span>
}
</pre>
</div>

</section>
<section id="slide-org76fa153">
<h3 id="org76fa153">Actor Reference 3/4</h3>
<p>
Alternate strategies:
</p>
<ul>
<li class="fragment appear">Use ActorSelection</li>
<li class="fragment appear">Use a Registry</li>

</ul>

</section>
<section id="slide-org3fd444b">
<h3 id="org3fd444b">Actor Reference 4/4</h3>
<p>
Avoid:
</p>
<ul>
<li class="fragment appear">Injecting using Cake Pattern</li>
<li class="fragment appear">Using a global object containing references (Oh&#x2026;My&#x2026;!)</li>

</ul>

</section>
<section id="slide-org38703eb">
<h3 id="org38703eb">Mutable properties</h3>
<p>
Actors can mutate properties safely because when processing a message there is no concurrency.
</p>

<p>
However, you must make sure you are in the same context !
</p>

</section>
<section id="slide-orgf64e27b">
<h3 id="orgf64e27b">Future &amp; context - The bad way</h3>
<p>
Inside a Future, you are no longer inside the Akka message processing context.
</p>

<div class="org-src-container">

<pre  class="fragment appear"><span style="color: #F92672;">object</span> <span style="color: #AE81FF;">Doer</span> {
  <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">doSomething</span>(message<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">Future</span>[<span style="color: #AE81FF;">String</span>] <span style="color: #F92672;">=</span> <span style="color: #75715E;">//</span><span style="color: #75715E;">...</span>
}

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">BadActor</span>(friend<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>) <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">var</span> <span style="color: #FD971F; font-weight: bold; font-style: italic; text-decoration: underline;">lastMessage</span> <span style="color: #F92672;">=</span> <span style="color: #E6DB74;">""</span>

  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">DoIt</span>(<span style="color: #FD971F;">message</span>) <span style="color: #F92672;">=&gt;</span>
      <span style="color: #75715E;">// </span><span style="color: #75715E;">Oh No !!!</span>
      <span style="color: #AE81FF;">Doer</span>.doSomething(message).map(lastMessage <span style="color: #F92672;">=</span> <span style="color: #F92672;">_</span>)
  }
}
</pre>
</div>

</section>
<section id="slide-orge27c0eb">
<h3 id="orge27c0eb">Future &amp; context - The good way</h3>
<p>
Avoid closure and use message to update Actor properties.
</p>

<div class="org-src-container">

<pre  class="src src-scala"><span style="color: #F92672;">object</span> <span style="color: #AE81FF;">Doer</span> {
  <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">doSomething</span>(message<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">Future</span>[<span style="color: #AE81FF;">String</span>] <span style="color: #F92672;">=</span> <span style="color: #75715E;">//</span><span style="color: #75715E;">...</span>
}

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">GoodActor</span>(friend<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>) <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">var</span> <span style="color: #FD971F; font-weight: bold; font-style: italic; text-decoration: underline;">lastMessage</span> <span style="color: #F92672;">=</span> <span style="color: #E6DB74;">""</span>

  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">DoIt</span>(<span style="color: #FD971F;">message</span>) <span style="color: #F92672;">=&gt;</span>
      <span style="color: #AE81FF;">Doer</span>.doSomething(message).map(<span style="color: #AE81FF;">Message</span>(<span style="color: #F92672;">_</span>)).pipeTo(self)

    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">Message</span>(<span style="color: #FD971F;">message</span>) <span style="color: #F92672;">=&gt;</span> lastMessage <span style="color: #F92672;">=</span> message

    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">akka.actor.Status.Failure</span>(<span style="color: #FD971F;">cause</span>) <span style="color: #F92672;">=&gt;</span> <span style="color: #75715E;">// </span><span style="color: #75715E;">Oops !</span>
  }
}
</pre>
</div>


</section>
<section id="slide-orga2e692d">
<h3 id="orga2e692d"><span class="todo TODO">TODO</span> EventBus</h3>
<ul>
<li>MemoryHog</li>
<li>No death watch by default</li>

</ul>

</section>
<section id="slide-org697da9a">
<h3 id="org697da9a"><span class="todo TODO">TODO</span> Testing - Black or White</h3>

<div class="figure">
<p><img src="./img/testing.png" alt="testing.png" />
</p>
</div>


</section>
<section id="slide-org1cc6b52">
<h3 id="org1cc6b52"><span class="todo TODO">TODO</span> Misc</h3>
<ul>
<li>Leaking</li>
<li>Ask pattern or create temp action actor</li>
<li>Mixing side-effect (injecting mutable object in an Actor)</li>
<li>Code consistency can be hard to maintain when evaluating patterns</li>
<li>Refactoring can be difficult</li>
<li>Monitoring</li>
<li>FSM</li>
<li>State become</li>
<li>Akka Cluster ?</li>

</ul>

</section>
<section id="slide-org46a7654">
<h3 id="org46a7654">Conclusion</h3>
<ul>
<li>And yet it works, despite all our mistakes&#x2026;</li>
<li>Architecture is key</li>
<li>You should read the doc ! <a href="http://doc.akka.io">http://doc.akka.io</a></li>

</ul>
</section>
</section>
</div>
</div>
<script src="./reveal.js/lib/js/head.min.js"></script>
<script src="./reveal.js/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: false,
rollingLinks: false,
keyboard: true,
overview: true,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: './reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
 { src: './reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: './reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
