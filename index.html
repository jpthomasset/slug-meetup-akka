<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Akka't the feeling</title>
<meta name="author" content="(Jean-Pierre Thomasset)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/css/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/css/theme/solarized.css" id="theme"/>

<link rel="stylesheet" href="style.css"/>

<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">

<section>
<section id="slide-org301c1ea">
<h2 id="org301c1ea">Akka't the feeling</h2>
<p>
A humble feedback on Akka after some time in production
</p>

</section>
</section>
<section>
<section id="slide-org3ef9bb3">
<h2 id="org3ef9bb3">Who are we ?</h2>

<div class="figure">
<p><img src="./img/logo_avencall.png" alt="logo_avencall.png" />
</p>
</div>
<ul>
<li>Open source software editor</li>
<li>7 developers across two locations (Lyon / Prague)</li>
<li>Mostly junior in Scala</li>

</ul>

</section>
<section id="slide-orgc98cfaa">
<h3 id="orgc98cfaa">XiVO Solution</h3>

<div class="figure">
<p><img src="./img/logo_xivo.png" alt="logo_xivo.png" />
</p>
</div>

<ul>
<li>Open Source IPBX based on Asterisk™</li>
<li>Phone Device Management</li>
<li>Call routing</li>
<li>Call Center Solution</li>
<li>Computer telephony Integration</li>

</ul>

</section>
<section id="slide-org9c771c2">
<h3 id="org9c771c2">XiVO Architecture overview</h3>

<div class="figure">
<p><img src="./img/xivo-overview.png" alt="xivo-overview.png" />
</p>
</div>

</section>
<section id="slide-org8b8c7cf">
<h3 id="org8b8c7cf">XUC Server</h3>
<ul>
<li>Real time message processing application</li>
<li>Using Akka</li>
<li>Expose API through Websocket &amp; Rest.</li>

</ul>

</section>
</section>
<section>
<section id="slide-org32880d7">
<h2 id="org32880d7">Akka</h2>
<blockquote nil>
<p>
“Akka is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala”
</p>

<p>
&#x2013; <a href="http://akka.io/">http://akka.io/</a>
</p>
</blockquote>

</section>
<section id="slide-org624ba65">
<h3 id="org624ba65">Akka Basics</h3>
<blockquote nil>
<p>
“Akka is <i>the</i> implementation of the Actor Model on the JVM.
</p>
<ul>
<li>Simpler Concurrent &amp; Distributed Systems</li>
<li>Resilient</li>
<li>High Performance</li>
<li>Elastic &amp; Decentralized”</li>

</ul>
</blockquote>

<blockquote  class="fragment appear">
<p>
“Multi-threading for dummies” <div align="right"><i>Jean-Yves Lebleu</i></div>
</p>
</blockquote>

</section>
<section id="slide-org1949618">
<h3 id="org1949618">Actors</h3>
<p>
Actors can:
</p>
<ul>
<li class="fragment appear">Receive messages</li>
<li class="fragment appear">Do things</li>
<li class="fragment appear">Send messages</li>

</ul>

<div class="org-src-container">

<pre  class="fragment appear"><span style="color: #F92672;">class</span> <span style="color: #66D9EF;">HelloActor</span> <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #E6DB74;">"Hello"</span> <span style="color: #F92672;">=&gt;</span>
      sender ! <span style="color: #E6DB74;">"Hi !"</span>
}
</pre>
</div>

</section>
<section id="slide-org0d9c19f">
<h3 id="org0d9c19f">A <del>call</del> tell B</h3>

<div class="figure">
<p><img src="./img/a_tell_b.png" alt="a_tell_b.png" />
</p>
</div>

<p>
Simple use cases are easy to implement but complexity kicks pretty soon.
</p>

</section>
<section id="slide-org53bd357">
<h3 id="org53bd357">A <del>call</del> tell B (continued)</h3>
<div class="org-src-container">

<pre  class="src src-scala"><span style="color: #F92672;">case</span> <span style="color: #F92672;">class</span> <span style="color: #66D9EF;">Hello</span>(name<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)
<span style="color: #F92672;">case</span> <span style="color: #F92672;">class</span> <span style="color: #66D9EF;">Greetings</span>(message<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">HelloActor</span>(greetingsRef<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>) {
  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">preStart</span><span style="color: #F92672;">:</span> <span style="color: #66D9EF;">Unit</span> <span style="color: #F92672;">=</span> {
    greetingsRef ! <span style="color: #AE81FF;">Hello</span>(<span style="color: #E6DB74;">"Jean-Pierre"</span>)
  }

  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">Greetings</span>(<span style="color: #FD971F;">message</span>) <span style="color: #F92672;">=&gt;</span>
      println(s<span style="color: #E6DB74;">"</span><span style="color: #FD971F;">$greetingsRef</span><span style="color: #E6DB74;"> told </span><span style="color: #FD971F;">$message</span><span style="color: #E6DB74;">"</span>)
  }
}

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">GreetingsActor</span> <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">Hello</span>(<span style="color: #FD971F;">name</span>) <span style="color: #F92672;">=&gt;</span>
      <span style="color: #75715E;">// </span><span style="color: #75715E;">I can do something here...</span>
      sender ! <span style="color: #AE81FF;">Greetings</span>(s<span style="color: #E6DB74;">"Hi </span><span style="color: #FD971F;">$name</span><span style="color: #E6DB74;">!"</span>)
}
</pre>
</div>

</section>
<section id="slide-orgdabab61">
<h3 id="orgdabab61">Actors message processing</h3>
<p>
Akka guarantees for Actors:
</p>
<ul>
<li>Only one message processed at a time</li>
<li>No concurrency inside an actor</li>
<li>At-most-once delivery</li>
<li>Message ordering per <b>sender-receiver pair</b></li>

</ul>


</section>
</section>
<section>
<section id="slide-org597c409">
<h2 id="org597c409">Akka @ Avencall</h2>
<blockquote nil>
<p>
Akka is a toolkit for building highly concurrent, <del>distributed</del>, and resilient message-driven applications for <del>Java and</del> Scala
</p>

<p>
&#x2013; <a href="http://akka.io/">http://akka.io/</a>
</p>
</blockquote>

</section>
</section>
<section>
<section id="slide-orgf6e4a45">
<h2 id="orgf6e4a45">Actor Hierarchy</h2>
<p>
One of our major problem was designing the Actor Hierarchy.
</p>


<div class="figure">
<p><img src="./img/no_hierarchy.png" alt="no_hierarchy.png" />
</p>
</div>

<p>
Or the lack of designing process&#x2026;
</p>

</section>
<section id="slide-orgdf8dc43">
<h3 id="orgdf8dc43">Actor Hierarchy</h3>
<p>
Is <i>the</i> key to have a resilient and understandable system&#x2026;
</p>

<ul>
<li>Actors dependency / discovery</li>
<li>Startup / Shutdown</li>
<li>Recovery</li>
<li>Message path</li>

</ul>

</section>
<section id="slide-orgac80fa6">
<h3 id="orgac80fa6">Actor Hierarchy - Designing</h3>

<div class="figure">
<p><img src="./img/hierarchy.png" alt="hierarchy.png" />
</p>
</div>

<p>
Designing will help you:
</p>
<ul>
<li>Split concerns and avoid bloated actors</li>
<li>Define clear message path</li>
<li>Evaluate behaviour without implementation</li>

</ul>

<p class="fragment appear">
Bonus: The actor model is easily mapped from a real world model.
</p>

</section>
<section id="slide-orgab917a4">
<h3 id="orgab917a4">Supervision &amp; Recovery</h3>
<p>
Without any strategy, actors can die and respawn without notice&#x2026;
</p>

<p class="fragment appear">
For each actor, you need to define a clear strategy for:
</p>
<ul>
<li class="fragment appear">Startup</li>
<li class="fragment appear">Shutdown</li>
<li class="fragment appear">Recovery</li>
<li class="fragment appear">Failure of its children</li>

</ul>

<p class="fragment appear">
Again, designing a hierarchy of actors will help in this process.
</p>

</section>
</section>
<section>
<section id="slide-org8bbf3d7">
<h2 id="org8bbf3d7">Actor Reference</h2>
<div class="outline-text-2" id="text-org8bbf3d7">
</div></section>
<section id="slide-org97d1cea">
<h3 id="org97d1cea">Actor Reference 1/4</h3>
<p>
In a non-trivial architecture, you will need your actors to collaborate.
</p>

<p>
They will need to know each other (somehow).
</p>

</section>
<section id="slide-org6a31d8d">
<h3 id="org6a31d8d">Actor Reference 2/4</h3>
<p>
Possible strategies:
</p>
<ul>
<li class="fragment appear">Inject ActorRef in Actor constructor</li>
<li class="fragment appear">Let the Actors introduce themselves</li>

</ul>

<div class="org-src-container">

<pre  class="fragment appear"><span style="color: #F92672;">case</span> <span style="color: #F92672;">class</span> <span style="color: #66D9EF;">IntroduceMe</span>(someFriend<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>, message<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">FriendlyActor</span>(friend<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>) <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">preStart</span><span style="color: #F92672;">:</span> <span style="color: #66D9EF;">Unit</span> <span style="color: #F92672;">=</span> {
    friend ! <span style="color: #AE81FF;">IntroduceMe</span>(self, <span style="color: #E6DB74;">"Hi there !"</span>)
  }
  <span style="color: #75715E;">// </span><span style="color: #75715E;">...</span>
}
</pre>
</div>

</section>
<section id="slide-org1fe5d3e">
<h3 id="org1fe5d3e">Actor Reference 3/4</h3>
<p>
Alternate strategies:
</p>
<ul>
<li class="fragment appear">Use ActorSelection</li>
<li class="fragment appear">Use a Registry</li>

</ul>

</section>
<section id="slide-orgb262ac7">
<h3 id="orgb262ac7">Actor Reference 4/4</h3>
<p>
Avoid:
</p>
<ul>
<li class="fragment appear">Injecting using Cake Pattern</li>
<li class="fragment appear">Using a global object containing references (Oh&#x2026;My&#x2026;!)</li>

</ul>

</section>
</section>
<section>
<section id="slide-org84ea597">
<h2 id="org84ea597">Message</h2>
<ul>
<li class="fragment appear">Messages need to be immutable: 
<ul>
<li>To prevent side effects</li>
<li>To avoid access exception</li>

</ul></li>
<li class="fragment appear">And serializable if system is distributed</li>

</ul>

<p class="fragment appear">
Bonus: Scala offers <code>case class</code>, use them
</p>

</section>
<section id="slide-org2dc8291">
<h3 id="org2dc8291">Message Path &amp; Routing</h3>
<p>
Messages can be hard to track (to put it mildly)
</p>
<ul>
<li class="fragment appear">Define them close to where they're used.</li>
<li class="fragment appear">Avoid complex routing or message over-encapsulation</li>
<li class="fragment appear">Prefer event sourcing over query pattern</li>
<li class="fragment appear">Design, design, design&#x2026;</li>

</ul>

</section>
</section>
<section>
<section id="slide-org04ad0fc">
<h2 id="org04ad0fc">Future</h2>
<div class="outline-text-2" id="text-org04ad0fc">
</div></section>
<section id="slide-org3f02711">
<h3 id="org3f02711">Mutable properties</h3>
<p>
Actors can mutate properties safely because when processing a message there is no concurrency.
</p>

<p>
However, you must make sure you are in the same context !
</p>

</section>
<section id="slide-orge49a45c">
<h3 id="orge49a45c">Future &amp; context</h3>
<p>
Inside a Future, you are no longer inside the Akka message processing context.
</p>

<div class="org-src-container">

<pre  class="fragment appear"><span style="color: #F92672;">object</span> <span style="color: #AE81FF;">Doer</span> {
  <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">doSomething</span>(message<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">Future</span>[<span style="color: #AE81FF;">String</span>] <span style="color: #F92672;">=</span> <span style="color: #75715E;">//</span><span style="color: #75715E;">...</span>
}

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">BadActor</span>(friend<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>) <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">var</span> <span style="color: #FD971F; font-weight: bold; font-style: italic; text-decoration: underline;">lastMessage</span> <span style="color: #F92672;">=</span> <span style="color: #E6DB74;">""</span>

  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">DoIt</span>(<span style="color: #FD971F;">message</span>) <span style="color: #F92672;">=&gt;</span>
      <span style="color: #75715E;">// </span><span style="color: #75715E;">Oh No !!!</span>
      <span style="color: #AE81FF;">Doer</span>.doSomething(message).map(lastMessage <span style="color: #F92672;">=</span> <span style="color: #F92672;">_</span>)
  }
}
</pre>
</div>

</section>
<section id="slide-orge815374">
<h3 id="orge815374">Future &amp; context - The good way</h3>
<p>
Avoid closure and use message to update Actor properties.
</p>

<div class="org-src-container">

<pre  class="src src-scala"><span style="color: #F92672;">object</span> <span style="color: #AE81FF;">Doer</span> {
  <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">doSomething</span>(message<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">String</span>)<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">Future</span>[<span style="color: #AE81FF;">String</span>] <span style="color: #F92672;">=</span> <span style="color: #75715E;">//</span><span style="color: #75715E;">...</span>
}

<span style="color: #F92672;">class</span> <span style="color: #66D9EF;">GoodActor</span>(friend<span style="color: #F92672;">:</span> <span style="color: #66D9EF;">ActorRef</span>) <span style="color: #F92672;">extends</span> <span style="color: #66D9EF;">Actor</span> {
  <span style="color: #F92672;">var</span> <span style="color: #FD971F; font-weight: bold; font-style: italic; text-decoration: underline;">lastMessage</span> <span style="color: #F92672;">=</span> <span style="color: #E6DB74;">""</span>

  <span style="color: #F92672;">override</span> <span style="color: #F92672;">def</span> <span style="color: #A6E22E;">receive</span> <span style="color: #F92672;">=</span> {
    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">DoIt</span>(<span style="color: #FD971F;">message</span>) <span style="color: #F92672;">=&gt;</span>
      <span style="color: #AE81FF;">Doer</span>.doSomething(message).map(<span style="color: #AE81FF;">Message</span>(<span style="color: #F92672;">_</span>)).pipeTo(self)

    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">Message</span>(<span style="color: #FD971F;">message</span>) <span style="color: #F92672;">=&gt;</span> lastMessage <span style="color: #F92672;">=</span> message

    <span style="color: #F92672;">case</span> <span style="color: #66D9EF;">akka.actor.Status.Failure</span>(<span style="color: #FD971F;">cause</span>) <span style="color: #F92672;">=&gt;</span> <span style="color: #75715E;">// </span><span style="color: #75715E;">Oops !</span>
  }
}
</pre>
</div>

</section>
</section>
<section>
<section id="slide-org5d40559">
<h2 id="org5d40559">Misc</h2>
<div class="outline-text-2" id="text-org5d40559">
</div></section>
<section id="slide-orge97851c">
<h3 id="orge97851c">EventBus</h3>
<p>
Akka offers a generic event bus mechanism with a customizable classification.
</p>

<p>
Pretty cool but&#x2026;
</p>

<ul>
<li class="fragment appear">Memory hog when using multiple level of classification</li>
<li class="fragment appear">No death watch by default could lead to memory leak</li>

</ul>

</section>
<section id="slide-org08d4455">
<h3 id="org08d4455">Testing - Black or White</h3>

<div class="figure">
<p><img src="./img/testing.png" alt="testing.png" />
</p>
</div>

<ul>
<li>Black box: Send input, assert on output</li>
<li>White box: Send input, assert on inner workings</li>

</ul>

</section>
<section id="slide-org476c3d2">
<h3 id="org476c3d2">Refactoring</h3>
<p>
Refactoring can be difficult but some tips can help:
</p>

<ul>
<li>Split concerns</li>
<li>Clear message paths</li>
<li>Lot of test</li>
<li>Be explicit in tests (wording &amp; coding)</li>

</ul>


</section>
<section id="slide-org95de369">
<h3 id="org95de369">Ask Pattern, Queries, Command</h3>
<ul>
<li>The ask pattern is convenient but returns a future so be cautious.</li>
<li>When used, this pattern creates a temporary actor to handle your query.</li>

</ul>
<ul class="fragment appear">
<li>Is there another way ?
<ul>
<li>If you use the pattern all over, you may need to change the design</li>
<li>Create a custom actor to handle this query</li>

</ul></li>

</ul>

</section>
<section id="slide-org4843331">
<h3 id="org4843331">Actor state</h3>
<p>
Akka offers convenient ways to handle state inside an actor:
</p>
<ul>
<li class="fragment appear">context.become(whatYouAre): easy to use</li>
<li class="fragment appear">FSM: For advanced usage</li>

</ul>

</section>
<section id="slide-org4923db3">
<h3 id="org4923db3">Coding with style&#x2026;</h3>
<ul>
<li class="fragment appear">Code consistency can be hard to maintain when evaluating patterns</li>
<li class="fragment appear">Mixing side-effect (injecting mutable object in an Actor)</li>
<li class="fragment appear">Monitoring will help</li>
<li class="fragment appear">Akka Cluster ?</li>

</ul>

</section>
</section>
<section>
<section id="slide-org51dcab6">
<h2 id="org51dcab6">Conclusion</h2>
<ul>
<li>And yet it works, despite all our mistakes&#x2026;</li>
<li>Designing you system is key</li>
<li>You should read the doc ! <a href="http://doc.akka.io">http://doc.akka.io</a></li>

</ul>

</section>
<section id="slide-org7db0b13">
<h3 id="org7db0b13">Thank you</h3>
<p>
Question ?
</p>

<p>
<a href="https://jpthomasset.github.io/slug-meetup-akka/">https://jpthomasset.github.io/slug-meetup-akka/</a>
</p>
</section>
</section>
</div>
</div>
<script src="./reveal.js/lib/js/head.min.js"></script>
<script src="./reveal.js/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: false,
rollingLinks: false,
keyboard: true,
overview: true,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: './reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
 { src: './reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: './reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
